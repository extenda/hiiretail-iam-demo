FROM node:14-slim as build

# Copy .npmrc file generated by extenda/actions/nexus-auth-npm@v0.
# to install private packages from Nexus registry
COPY .npmrc ./

WORKDIR /work
COPY . /work/

RUN yarn install --frozen-lockfile
RUN yarn build

# Distribution
FROM nginx:1-alpine
LABEL maintainer="Extenda Retail <devops@extendaretail.com>"

# Update all packages to latest versions without vulnerabilities
RUN apk update && apk upgrade

ENV PORT 8080
EXPOSE 8080

# Copy nginx config
#COPY nginx.conf /etc/nginx/conf.d/default.conf

# Copy entrypoint.sh for runtime env configuration (optional)
COPY entrypoint.sh /etc/nginx/entrypoint.sh
COPY --from=build /work/build /var/www/

ENTRYPOINT ["/etc/nginx/entrypoint.sh"]
